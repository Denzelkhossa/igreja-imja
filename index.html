<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel Administrativo I.M.J.A — Admin</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    body{background:#f8fafc;color:#1e293b;font-family:'Segoe UI',sans-serif;padding:20px;min-height:100vh}
    .container{max-width:800px;margin:0 auto}
    .card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
    .login-title{font-size:20px;font-weight:bold;margin-bottom:10px}
    .muted{color:#64748b}
    input,select,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-bottom:12px}
    button{background:#3b82f6;color:#fff;padding:10px 15px;border:none;border-radius:6px;cursor:pointer}
    button:hover{background:#1e3a8a}
    #adminSection{display:none}
    .note{margin-top:10px;padding:10px;border-radius:6px}
    .note.error{background:#fee2e2;color:#dc2626}
    .note.success{background:#dcfce7;color:#16a34a}
  </style>
</head>
<body>
  <div class="container">

    <!-- LOGIN -->
    <section id="loginSection" class="card">
      <div class="login-title"><i class="fa-solid fa-lock"></i> Acesso Administrativo</div>
      <p class="muted">Entre com as credenciais do administrador para gerenciar os posts.</p>

      <form onsubmit="doLogin(); return false;">
        <input type="email" id="adminEmail" placeholder="E-mail"/>
        <input type="password" id="adminPass" placeholder="Senha"/>
        <button type="submit">Entrar</button>
      </form>
      <div id="loginNote" class="note error" style="display:none"></div>
    </section>

    <!-- ADMIN PANEL -->
    <section id="adminSection" class="card">
      <h2>Painel Administrativo</h2>
      <button onclick="logout()">Sair</button>
      <hr/><br/>

      <!-- Formulário de criação de post -->
      <form id="postForm" onsubmit="createOrUpdatePost(); return false;">
        <input type="text" id="postTitle" placeholder="Título do post"/>
        <textarea id="postContent" placeholder="Conteúdo"></textarea>
        <select id="postType" onchange="toggleFields()">
          <option value="text">Texto</option>
          <option value="image">Imagem</option>
          <option value="video">Vídeo</option>
          <option value="audio">Áudio</option>
          <option value="youtube">YouTube</option>
        </select>
        <input type="file" id="postImage" accept="image/*" style="display:none"/>
        <input type="file" id="postVideo" accept="video/*" style="display:none"/>
        <input type="file" id="postAudio" accept="audio/*" style="display:none"/>
        <input type="url" id="youtubeUrl" placeholder="URL do YouTube" style="display:none"/>
        <img id="imagePreview" style="max-width:100%;display:none;margin-top:10px"/>
        <button id="createPostBtn" type="submit"><i class="fas fa-paper-plane"></i> Publicar Post</button>
        <button type="button" id="cancelEditBtn" onclick="clearForm()" style="display:none">Cancelar edição</button>
      </form>

      <hr/><br/>
      <h3>Posts publicados</h3>
      <div id="postsList"></div>
      <div id="notify" class="note" style="display:none"></div>
    </section>

  </div>

  <!-- Firebase SDK v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <script>
    // =========================
    // CONFIG FIREBASE
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyBgWfocz6rpycz3SiJJ39Nfc1gNUd6kafk",
      authDomain: "imjachurch.firebaseapp.com",
      projectId: "imjachurch",
      storageBucket: "imjachurch.appspot.com",
      messagingSenderId: "145864254479",
      appId: "1:145864254479:web:3c1e6f5b3b5e5f5b5e5f5b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // =========================
    // LOGIN LOCAL
    // =========================
    const ADMIN_EMAIL = "ministerio.554411@gmail.com";
    const ADMIN_PASS  = "imjachurch";

    function setView(loggedIn){
      document.getElementById('loginSection').style.display = loggedIn ? 'none':'block';
      document.getElementById('adminSection').style.display = loggedIn ? 'block':'none';
    }

    function showLoginNote(msg,type='error'){
      const n = document.getElementById('loginNote');
      n.textContent = msg;
      n.className = 'note ' + (type==='success'?'success':'error');
      n.style.display = 'block';
      setTimeout(()=>{ n.style.display = 'none'; },4000);
    }

    function doLogin(){
      const email = document.getElementById('adminEmail').value.trim();
      const pass  = document.getElementById('adminPass').value;
      if(email===ADMIN_EMAIL && pass===ADMIN_PASS){
        localStorage.setItem('adminUser', email);
        setView(true);
        loadPosts();
      }else{
        showLoginNote('Credenciais inválidas.','error');
      }
    }

    function logout(){
      localStorage.removeItem('adminUser');
      setView(false);
    }

    document.addEventListener('DOMContentLoaded',()=>{
      if(localStorage.getItem('adminUser')){ setView(true); loadPosts(); }
      else{ setView(false); }
    });

    // =========================
    // CRUD POSTS (simplificado)
    // =========================
    let posts=[], currentEditPostId=null;

    function toggleFields(){
      document.getElementById('postImage').style.display='none';
      document.getElementById('postVideo').style.display='none';
      document.getElementById('postAudio').style.display='none';
      document.getElementById('youtubeUrl').style.display='none';
      const t=document.getElementById('postType').value;
      if(t==='image') document.getElementById('postImage').style.display='block';
      if(t==='video') document.getElementById('postVideo').style.display='block';
      if(t==='audio') document.getElementById('postAudio').style.display='block';
      if(t==='youtube') document.getElementById('youtubeUrl').style.display='block';
    }

    async function createOrUpdatePost(){
      const title=document.getElementById('postTitle').value.trim();
      const content=document.getElementById('postContent').value.trim();
      const type=document.getElementById('postType').value;
      let mediaUrl='';
      try{
        if(type==='image'){
          const f=document.getElementById('postImage').files[0];
          if(f){ mediaUrl=await uploadFile(f,'images'); }
        }
        if(type==='video'){
          const f=document.getElementById('postVideo').files[0];
          if(f){ mediaUrl=await uploadFile(f,'videos'); }
        }
        if(type==='audio'){
          const f=document.getElementById('postAudio').files[0];
          if(f){ mediaUrl=await uploadFile(f,'audios'); }
        }
        if(type==='youtube'){
          mediaUrl=document.getElementById('youtubeUrl').value.trim();
        }

        const base={title,content,type,mediaUrl,createdAt:firebase.firestore.FieldValue.serverTimestamp()};

        if(currentEditPostId){
          await db.collection('posts').doc(currentEditPostId).update(base);
        }else{
          await db.collection('posts').add(base);
        }
        clearForm(); loadPosts();
      }catch(err){ alert('Erro: '+err.message); }
    }

    async function uploadFile(file,folder){
      const ref=storage.ref().child(folder+'/'+Date.now()+'_'+file.name);
      await ref.put(file);
      return await ref.getDownloadURL();
    }

    function loadPosts(){
      const list=document.getElementById('postsList');
      list.innerHTML='Carregando...';
      db.collection('posts').orderBy('createdAt','desc').get().then(snap=>{
        list.innerHTML='';
        snap.forEach(doc=>{
          const data=doc.data();
          const div=document.createElement('div');
          div.style.border='1px solid #ccc';div.style.padding='10px';div.style.margin='10px 0';
          div.innerHTML=`<b>${data.title}</b><br/>${data.content||''}<br/>
            ${data.mediaUrl?('<a href="'+data.mediaUrl+'" target="_blank">[mídia]</a>'):""}
            <br/><button onclick="deletePost('${doc.id}')">Excluir</button>`;
          list.appendChild(div);
        });
      });
    }

    function deletePost(id){
      if(confirm('Excluir post?')){
        db.collection('posts').doc(id).delete().then(loadPosts);
      }
    }

    function clearForm(){
      document.getElementById('postForm').reset();
      currentEditPostId=null;
    }
  </script>
</body>
</html>