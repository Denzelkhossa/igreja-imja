<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel Administrativo - Ministério dos Justos Aperfeiçoados</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root {
      --primary-color:#0056b3; --primary-color-dark:#003d82; --primary-color-light:#e6f0ff;
      --secondary-color:#ff6b00; --background-primary:#ffffff; --background-secondary:#f8f9fa;
      --text-primary:#333333; --text-secondary:#666666; --text-light:#999999;
      --border-color:#e0e0e0; --shadow:0 2px 10px rgba(0,0,0,.05); --shadow-hover:0 5px 15px rgba(0,0,0,.1);
      --error-color:#d32f2f; --success-color:#388e3c; --warning-color:#f57c00; --radius:8px; --transition:.3s ease; --sidebar-width:250px;
    }
    [data-theme="dark"] {
      --primary-color:#4a90e2; --primary-color-dark:#2a5c99; --primary-color-light:#1a2a40;
      --background-primary:#121212; --background-secondary:#1E1E1E; --text-primary:#E0E0E0; --text-secondary:#b0b3b8;
      --border-color:#333; --shadow:0 4px 6px rgba(0,0,0,.3);
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Open Sans','Lato',Arial,sans-serif}
    body{background:var(--background-secondary);color:var(--text-primary);line-height:1.6}

    /* Login overlay */
    .login-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--background-secondary);z-index:3000}
    .login-card{background:var(--background-primary);border-radius:var(--radius);box-shadow:var(--shadow);padding:2rem;max-width:420px;width:92%}
    .login-card h1{font-size:1.25rem;margin-bottom:.5rem;color:var(--primary-color)}
    .login-card p{color:var(--text-secondary);margin-bottom:1.25rem}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem 1rem;border:none;border-radius:var(--radius);cursor:pointer;
         background:var(--primary-color);color:#fff;font-weight:600;transition:var(--transition);text-decoration:none}
    .btn:hover{background:var(--primary-color-dark);transform:translateY(-2px);box-shadow:var(--shadow-hover)}
    .btn-outline{background:transparent;border:1px solid var(--primary-color);color:var(--primary-color)}
    .btn-danger{background:var(--error-color)} .btn-success{background:var(--success-color)} .btn-warning{background:var(--warning-color)}
    .btn-sm{padding:.4rem .7rem;font-size:.85rem}
    .note{display:none;margin-top:.75rem;padding:.6rem;border-radius:6px;font-size:.9rem}
    .note.error{background:#ffebee;color:var(--error-color);border:1px solid #ffcdd2}
    .note.success{background:#e8f5e9;color:var(--success-color);border:1px solid #c8e6c9}

    /* Layout */
    .admin-container{display:flex;min-height:100vh}
    .admin-sidebar{width:var(--sidebar-width);background:var(--primary-color-dark);color:#fff;position:fixed;height:100vh;overflow-y:auto;z-index:1000}
    .admin-sidebar-header{padding:1.5rem 1rem;border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center;gap:.8rem}
    .admin-sidebar-header img{width:40px;height:40px;border-radius:50%;border:2px solid #fff}
    .admin-sidebar-header h2{font-size:1.1rem;font-weight:600}
    .admin-nav{padding:1rem 0}
    .nav-section{padding:.5rem 1.5rem;font-size:.8rem;text-transform:uppercase;color:rgba(255,255,255,.6);margin-top:1rem}
    .nav-item{padding:.8rem 1.5rem;display:flex;align-items:center;gap:.8rem;color:rgba(255,255,255,.85);text-decoration:none;cursor:pointer}
    .nav-item:hover,.nav-item.active{background:rgba(255,255,255,.12);color:#fff}
    .nav-item i{width:20px;text-align:center}
    .admin-main{flex:1;margin-left:var(--sidebar-width);padding:1.5rem}
    .admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border-color)}
    .admin-title{font-size:1.6rem;color:var(--primary-color)}
    .admin-card{background:var(--background-primary);border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:1.5rem;overflow:hidden}
    .card-header{padding:1rem 1.25rem;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
    .card-title{font-size:1.1rem;font-weight:600;color:var(--primary-color)}
    .card-content{padding:1.2rem;overflow-x:auto}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(220px,1fr));gap:1rem;margin-bottom:1.5rem}
    .stat-card{background:var(--background-primary);border-radius:var(--radius);padding:1rem;box-shadow:var(--shadow);display:flex;gap:.9rem;align-items:center}
    .stat-icon{width:46px;height:46px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--primary-color-light);color:var(--primary-color)}
    .stat-value{font-size:1.4rem;font-weight:700}
    .stat-label{font-size:.9rem;color:var(--text-secondary)}
    .admin-table{width:100%;border-collapse:collapse}
    .admin-table th,.admin-table td{padding:.7rem 1rem;border-bottom:1px solid var(--border-color);text-align:left}
    .admin-table th{background:var(--background-secondary)}
    .badge{display:inline-block;padding:.25rem .55rem;border-radius:20px;font-size:.75rem;font-weight:700}
    .badge-success{background:#e8f5e9;color:var(--success-color)} .badge-warning{background:#fff3e0;color:var(--warning-color)}
    .badge-info{background:#e3f2fd;color:var(--primary-color)}
    .badge-secondary{background:#f5f5f5;color:#666}
    .hidden{display:none}

    /* Forms */
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;margin-bottom:1rem}
    .form-group{margin-bottom:1rem}
    .form-label{display:block;margin-bottom:.4rem;font-weight:600}
    .form-control{width:100%;padding:.7rem;border:1px solid var(--border-color);border-radius:var(--radius);background:var(--background-primary);color:var(--text-primary)}
    .form-control:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(0,86,179,.15)}
    textarea.form-control{min-height:110px;resize:vertical}
    select.form-control{appearance:none;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right .7rem center;background-size:16px;padding-right:2.5rem}

    /* Media preview */
    .media-preview{margin-top:.5rem;max-width:100%;max-height:220px;border-radius:6px;display:none}

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:2000;padding:1rem}
    .modal-content{background:var(--background-primary);border-radius:var(--radius);width:100%;max-width:680px;max-height:90vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .modal-header{padding:1rem 1.25rem;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-size:1.2rem;font-weight:700;color:var(--primary-color)}
    .modal-body{padding:1rem 1.25rem}
    .modal-footer{padding:1rem 1.25rem;border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:.6rem}

    /* Cards para grupos e relatórios */
    .card-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));gap:1rem;margin-bottom:1.5rem}
    .group-card,.report-card{background:var(--background-primary);border-radius:var(--radius);box-shadow:var(--shadow);padding:1rem;position:relative}
    .group-card h3,.report-card h3{margin-bottom:.5rem;color:var(--primary-color)}
    .group-details,.report-details{display:flex;flex-direction:column;gap:.4rem;margin-bottom:.8rem}
    .group-detail,.report-detail{display:flex;align-items:center;gap:.5rem;font-size:.9rem;color:var(--text-secondary)}
    .group-detail i,.report-detail i{width:16px;color:var(--primary-color)}
    .group-actions,.report-actions{display:flex;gap:.5rem;margin-top:.8rem}
    .member-list{margin-top:.8rem;border-top:1px solid var(--border-color);padding-top:.8rem}
    .member-item{display:flex;align-items:center;gap:.5rem;padding:.4rem 0;font-size:.9rem}
    .member-role{font-size:.7rem;padding:.2rem .4rem;background:var(--primary-color-light);color:var(--primary-color);border-radius:4px}

    /* Responsive sidebar */
    @media (max-width: 992px){
      .admin-sidebar{width:70px}
      .admin-sidebar-header h2,.nav-item span,.nav-section{display:none}
      .admin-main{margin-left:70px}
      .nav-item{justify-content:center;padding:.9rem}
    }
  </style>
  
  <!-- Firebase SDK v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
</head>
<body>

  <!-- LOGIN -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-card">
      <h1><i class="fa-solid fa-lock"></i> Acesso Administrativo</h1>
      <p>Faça login com sua conta Google autorizada para gerenciar o conteúdo.</p>
      <button class="btn" id="googleSignInBtn"><i class="fa-brands fa-google"></i> Entrar com Google</button>
      <div id="loginNote" class="note"></div>
    </div>
  </div>

  <!-- APP -->
  <div class="admin-container" id="app" style="display:none">
    <!-- Sidebar -->
    <div class="admin-sidebar">
      <div class="admin-sidebar-header">
        <img src="https://i.ibb.co/rfLWMXK7/FB-IMG-1748755074055.jpg" alt="Logo IMJA">
        <h2>Painel Administrativo</h2>
      </div>
      <nav class="admin-nav">
        <div class="nav-section">Principal</div>
        <a href="#" class="nav-item active" data-tab="dashboard"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>

        <div class="nav-section">Conteúdo</div>
        <a href="#" class="nav-item" data-tab="posts"><i class="fas fa-newspaper"></i><span>Posts</span></a>
        <a href="#" class="nav-item" data-tab="events"><i class="fas fa-calendar-alt"></i><span>Eventos</span></a>
        <a href="#" class="nav-item" data-tab="prayers"><i class="fas fa-pray"></i><span>Pedidos de Oração</span></a>

        <div class="nav-section">Grupos Familiares</div>
        <a href="#" class="nav-item" data-tab="groups"><i class="fas fa-home"></i><span>Grupos/Células</span></a>
        <a href="#" class="nav-item" data-tab="reports"><i class="fas fa-chart-line"></i><span>Relatórios</span></a>

        <div class="nav-section">Sessão</div>
        <a href="#" class="nav-item" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a>
      </nav>
    </div>

    <!-- Main -->
    <div class="admin-main">
      <!-- Dashboard -->
      <div class="admin-content-section" id="dashboard">
        <div class="admin-header">
          <h1 class="admin-title">Dashboard</h1>
          <div class="admin-actions">
            <button class="btn" id="refreshBtn"><i class="fas fa-sync-alt"></i> Atualizar</button>
            <button class="btn btn-success" onclick="openModal('eventModal')"><i class="fas fa-plus"></i> Novo Evento</button>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon"><i class="fas fa-newspaper"></i></div><div><div class="stat-value" id="statPosts">0</div><div class="stat-label">Total de Posts</div></div></div>
          <div class="stat-card"><div class="stat-icon"><i class="fas fa-calendar-alt"></i></div><div><div class="stat-value" id="statEvents">0</div><div class="stat-label">Próximos Eventos</div></div></div>
          <div class="stat-card"><div class="stat-icon"><i class="fas fa-pray"></i></div><div><div class="stat-value" id="statPrayers">0</div><div class="stat-label">Pedidos de Oração</div></div></div>
          <div class="stat-card"><div class="stat-icon"><i class="fas fa-home"></i></div><div><div class="stat-value" id="statGroups">0</div><div class="stat-label">Grupos Ativos</div></div></div>
        </div>

        <!-- Últimos posts -->
        <div class="admin-card">
          <div class="card-header">
            <h3 class="card-title">Últimos Posts</h3>
          </div>
          <div class="card-content">
            <table class="admin-table" id="latestPostsTable">
              <thead><tr><th>Título</th><th>Tipo</th><th>Categoria</th><th>Data</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Grupos Familiares -->
      <div class="admin-content-section hidden" id="groups">
        <div class="admin-header">
          <h1 class="admin-title">Gerenciar Grupos Familiares</h1>
          <button class="btn btn-success" onclick="openModal('groupModal')"><i class="fas fa-plus"></i> Novo Grupo</button>
        </div>

        <div class="admin-card">
          <div class="card-header">
            <h3 class="card-title">Todos os Grupos</h3>
            <div class="card-actions" style="display:flex;gap:.5rem;align-items:center">
              <input id="searchGroups" class="form-control" placeholder="Buscar grupos..." oninput="filterGroups(this.value)" style="max-width:240px">
            </div>
          </div>
          <div class="card-content">
            <div id="groupsList">
              <div class="text-center" style="color:var(--text-secondary)">Carregando grupos...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Relatórios -->
      <div class="admin-content-section hidden" id="reports">
        <div class="admin-header">
          <h1 class="admin-title">Relatórios de Grupos</h1>
          <button class="btn btn-success" onclick="openModal('reportModal')"><i class="fas fa-plus"></i> Novo Relatório</button>
        </div>

        <div class="admin-card">
          <div class="card-header">
            <h3 class="card-title">Relatórios Recentes</h3>
            <div class="card-actions" style="display:flex;gap:.5rem;align-items:center">
              <select id="filterGroup" class="form-control" onchange="filterReportsByGroup(this.value)" style="max-width:200px">
                <option value="">Todos os grupos</option>
              </select>
              <input id="searchReports" class="form-control" placeholder="Buscar relatórios..." oninput="filterReports(this.value)" style="max-width:240px">
            </div>
          </div>
          <div class="card-content">
            <div id="reportsList">
              <div class="text-center" style="color:var(--text-secondary)">Carregando relatórios...</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Modal Grupo -->
  <div class="modal-overlay" id="groupModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="groupModalTitle">Adicionar Novo Grupo</h2>
        <button class="btn btn-outline btn-sm" onclick="closeModal('groupModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="groupForm">
          <input type="hidden" id="groupId">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="groupName">Nome do Grupo</label>
              <input type="text" id="groupName" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="groupDay">Dia da Reunião</label>
              <select id="groupDay" class="form-control" required>
                <option value="">Selecione</option>
                <option value="domingo">Domingo</option>
                <option value="segunda">Segunda-feira</option>
                <option value="terca">Terça-feira</option>
                <option value="quarta">Quarta-feira</option>
                <option value="quinta">Quinta-feira</option>
                <option value="sexta">Sexta-feira</option>
                <option value="sabado">Sábado</option>
              </select>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="groupTime">Horário</label>
              <input type="time" id="groupTime" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="groupZone">Zona/Região</label>
              <select id="groupZone" class="form-control" required>
                <option value="">Selecione</option>
                <option value="central">Zona Central</option>
                <option value="norte">Zona Norte</option>
                <option value="sul">Zona Sul</option>
                <option value="leste">Zona Leste</option>
                <option value="oeste">Zona Oeste</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="groupAddress">Endereço</label>
            <textarea id="groupAddress" class="form-control" rows="2" required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label" for="groupLeader">Líder do Grupo</label>
            <input type="text" id="groupLeader" class="form-control" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="groupLeaderPhone">Telefone do Líder</label>
            <input type="tel" id="groupLeaderPhone" class="form-control" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="groupCapacity">Capacidade (máx. participantes)</label>
            <input type="number" id="groupCapacity" class="form-control" min="1" value="15">
          </div>
          <div class="form-group">
            <label class="form-label" for="groupStatus">Status</label>
            <select id="groupStatus" class="form-control" required>
              <option value="active">Ativo</option>
              <option value="inactive">Inativo</option>
              <option value="pending">Pendente</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('groupModal')">Cancelar</button>
        <button class="btn btn-success" type="submit" form="groupForm">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal Relatório -->
  <div class="modal-overlay" id="reportModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="reportModalTitle">Adicionar Novo Relatório</h2>
        <button class="btn btn-outline btn-sm" onclick="closeModal('reportModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="reportForm">
          <input type="hidden" id="reportId">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="reportGroup">Grupo</label>
              <select id="reportGroup" class="form-control" required>
                <option value="">Selecione um grupo</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="reportDate">Data do Encontro</label>
              <input type="date" id="reportDate" class="form-control" required>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="reportAttendance">Número de Participantes</label>
              <input type="number" id="reportAttendance" class="form-control" min="0" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="reportNewMembers">Novos Membros</label>
              <input type="number" id="reportNewMembers" class="form-control" min="0" value="0">
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="reportOffering">Oferta Coletada (MT)</label>
              <input type="number" id="reportOffering" class="form-control" min="0" step="0.01" value="0">
            </div>
            <div class="form-group">
              <label class="form-label" for="reportStudy">Estudo Realizado</label>
              <input type="text" id="reportStudy" class="form-control" placeholder="Tema do estudo">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="reportNotes">Observações</label>
            <textarea id="reportNotes" class="form-control" rows="3" placeholder="Detalhes do encontro, necessidades, testemunhos..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label" for="reportChallenges">Desafios/Dificuldades</label>
            <textarea id="reportChallenges" class="form-control" rows="2" placeholder="Desafios enfrentados pelo grupo"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('reportModal')">Cancelar</button>
        <button class="btn btn-success" type="submit" form="reportForm">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIGURAÇÃO DO FIREBASE ======
    const firebaseConfig = {
      apiKey: "AIzaSyBgWfocz6rpycz3SiJJ39Nfc1gNUd6kafk",
      authDomain: "imjachurch.firebaseapp.com",
      projectId: "imjachurch",
      storageBucket: "imjachurch.appspot.com",
      messagingSenderId: "145864254479",
      appId: "1:145864254479:web:3c1e6f5b3b5e5f5b5e5f5b"
    };
    
    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    
    // ====== LISTA DE ADMINISTRADORES AUTORIZADOS ======
    const ALLOWED_EMAILS = new Set([
      "denzelkhossa@gmail.com",
      "ministerio.554411@gmail.com",
      "calvinocossa6@gmail.com",
      "hjsdesousa@gmail.com"
    ]);
    
    // ====== VARIÁVEIS GLOBAIS ======
    let groups = [];
    let reports = [];
    
    // ====== FUNÇÕES DE INICIALIZAÇÃO ======
    document.addEventListener('DOMContentLoaded', function() {
      // Configurar listeners
      document.getElementById('googleSignInBtn').addEventListener('click', loginWithGoogle);
      document.getElementById('logoutBtn').addEventListener('click', logout);
      
      // Configurar navegação
      document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
        item.addEventListener('click', function() {
          const tabName = this.getAttribute('data-tab');
          showTab(tabName);
        });
      });
      
      // Configurar formulários
      document.getElementById('groupForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveGroup();
      });
      
      document.getElementById('reportForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveReport();
      });
      
      // Verificar se já está logado
      auth.onAuthStateChanged(user => {
        if (user) {
          const email = user.email.toLowerCase();
          if (ALLOWED_EMAILS.has(email)) {
            showApp();
            loadGroups();
            loadReports();
            populateGroupDropdown();
          } else {
            auth.signOut();
            showLoginNote('Acesso negado: e-mail não autorizado.');
          }
        } else {
          document.getElementById('loginOverlay').style.display = 'flex';
          document.getElementById('app').style.display = 'none';
        }
      });
    });
    
    // ====== AUTENTICAÇÃO ======
    function loginWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => {
          const email = result.user.email.toLowerCase();
          if (!ALLOWED_EMAILS.has(email)) {
            auth.signOut();
            showLoginNote('Acesso negado: e-mail não autorizado.');
          }
        })
        .catch(error => {
          console.error('Erro no login:', error);
          showLoginNote('Erro ao fazer login: ' + error.message);
        });
    }
    
    function logout() {
      auth.signOut()
        .then(() => {
          document.getElementById('loginOverlay').style.display = 'flex';
          document.getElementById('app').style.display = 'none';
        })
        .catch(error => {
          console.error('Erro no logout:', error);
        });
    }
    
    function showLoginNote(message, type = 'error') {
      const note = document.getElementById('loginNote');
      note.textContent = message;
      note.className = `note ${type}`;
      note.style.display = 'block';
      
      setTimeout(() => {
        note.style.display = 'none';
      }, 5000);
    }
    
    function showApp() {
      document.getElementById('loginOverlay').style.display = 'none';
      document.getElementById('app').style.display = 'flex';
    }
    
    // ====== NAVEGAÇÃO ======
    function showTab(tabName) {
      // Esconder todas as abas
      document.querySelectorAll('.admin-content-section').forEach(tab => {
        tab.classList.add('hidden');
      });
      
      // Mostrar a aba selecionada
      document.getElementById(tabName).classList.remove('hidden');
      
      // Atualizar navegação ativa
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`.nav-item[data-tab="${tabName}"]`).classList.add('active');
    }
    
    // ====== GRUPOS FAMILIARES ======
    function loadGroups() {
      const groupsList = document.getElementById('groupsList');
      groupsList.innerHTML = '<div class="text-center" style="color:var(--text-secondary)">Carregando grupos...</div>';
      
      db.collection('groups').orderBy('name').get()
        .then(snapshot => {
          groups = [];
          groupsList.innerHTML = '<div class="card-grid" id="groupsGrid"></div>';
          const groupsGrid = document.getElementById('groupsGrid');
          
          if (snapshot.empty) {
            groupsGrid.innerHTML = '<div class="text-center" style="color:var(--text-secondary);grid-column:1/-1">Nenhum grupo cadastrado ainda.</div>';
            return;
          }
          
          snapshot.forEach(doc => {
            const group = { id: doc.id, ...doc.data() };
            groups.push(group);
            
            const groupCard = document.createElement('div');
            groupCard.className = 'group-card';
            
            let statusBadge = '';
            if (group.status === 'active') {
              statusBadge = '<span class="badge badge-success" style="position:absolute;top:1rem;right:1rem">Ativo</span>';
            } else if (group.status === 'inactive') {
              statusBadge = '<span class="badge badge-secondary" style="position:absolute;top:1rem;right:1rem">Inativo</span>';
            } else {
              statusBadge = '<span class="badge badge-warning" style="position:absolute;top:1rem;right:1rem">Pendente</span>';
            }
            
            groupCard.innerHTML = `
              ${statusBadge}
              <h3>${escapeHtml(group.name)}</h3>
              <div class="group-details">
                <div class="group-detail"><i class="fas fa-user"></i> <span>Líder: ${escapeHtml(group.leader)}</span></div>
                <div class="group-detail"><i class="fas fa-map-marker-alt"></i> <span>${escapeHtml(group.address)}</span></div>
                <div class="group-detail"><i class="fas fa-calendar-day"></i> <span>${capitalizeFirstLetter(group.day)} às ${group.time}</span></div>
                <div class="group-detail"><i class="fas fa-users"></i> <span>Capacidade: ${group.capacity} pessoas</span></div>
                <div class="group-detail"><i class="fas fa-map"></i> <span>Zona: ${capitalizeFirstLetter(group.zone)}</span></div>
              </div>
              <div class="group-actions">
                <button class="btn btn-sm" onclick="editGroup('${group.id}')"><i class="fas fa-edit"></i> Editar</button>
                <button class="btn btn-sm btn-danger" onclick="deleteGroup('${group.id}')"><i class="fas fa-trash"></i> Excluir</button>
              </div>
            `;
            
            groupsGrid.appendChild(groupCard);
          });
          
          // Atualizar estatísticas
          document.getElementById('statGroups').textContent = groups.filter(g => g.status === 'active').length;
        })
        .catch(error => {
          console.error('Erro ao carregar grupos:', error);
          groupsList.innerHTML = '<div class="text-center" style="color:var(--error-color)">Erro ao carregar grupos.</div>';
        });
    }
    
    function saveGroup() {
      const groupId = document.getElementById('groupId').value;
      const groupData = {
        name: document.getElementById('groupName').value,
        day: document.getElementById('groupDay').value,
        time: document.getElementById('groupTime').value,
        zone: document.getElementById('groupZone').value,
        address: document.getElementById('groupAddress').value,
        leader: document.getElementById('groupLeader').value,
        leaderPhone: document.getElementById('groupLeaderPhone').value,
        capacity: parseInt(document.getElementById('groupCapacity').value),
        status: document.getElementById('groupStatus').value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      if (groupId) {
        // Atualizar grupo existente
        db.collection('groups').doc(groupId).update(groupData)
          .then(() => {
            showNotification('Grupo atualizado com sucesso!', 'success');
            closeModal('groupModal');
            loadGroups();
          })
          .catch(error => {
            console.error('Erro ao atualizar grupo:', error);
            showNotification('Erro ao atualizar grupo: ' + error.message, 'error');
          });
      } else {
        // Criar novo grupo
        groupData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        
        db.collection('groups').add(groupData)
          .then(() => {
            showNotification('Grupo criado com sucesso!', 'success');
            closeModal('groupModal');
            loadGroups();
            populateGroupDropdown();
          })
          .catch(error => {
            console.error('Erro ao criar grupo:', error);
            showNotification('Erro ao criar grupo: ' + error.message, 'error');
          });
      }
    }
    
    function editGroup(id) {
      const group = groups.find(g => g.id === id);
      if (!group) return;
      
      document.getElementById('groupId').value = group.id;
      document.getElementById('groupName').value = group.name;
      document.getElementById('groupDay').value = group.day;
      document.getElementById('groupTime').value = group.time;
      document.getElementById('groupZone').value = group.zone;
      document.getElementById('groupAddress').value = group.address;
      document.getElementById('groupLeader').value = group.leader;
      document.getElementById('groupLeaderPhone').value = group.leaderPhone;
      document.getElementById('groupCapacity').value = group.capacity;
      document.getElementById('groupStatus').value = group.status;
      
      document.getElementById('groupModalTitle').textContent = 'Editar Grupo';
      openModal('groupModal');
    }
    
    function deleteGroup(id) {
      if (!confirm('Tem certeza que deseja excluir este grupo?')) return;
      
      db.collection('groups').doc(id).delete()
        .then(() => {
          showNotification('Grupo excluído com sucesso!', 'success');
          loadGroups();
          populateGroupDropdown();
        })
        .catch(error => {
          console.error('Erro ao excluir grupo:', error);
          showNotification('Erro ao excluir grupo: ' + error.message, 'error');
        });
    }
    
    function filterGroups(query) {
      const filteredGroups = groups.filter(group => 
        group.name.toLowerCase().includes(query.toLowerCase()) ||
        group.leader.toLowerCase().includes(query.toLowerCase()) ||
        group.address.toLowerCase().includes(query.toLowerCase()) ||
        group.zone.toLowerCase().includes(query.toLowerCase())
      );
      
      const groupsGrid = document.getElementById('groupsGrid');
      groupsGrid.innerHTML = '';
      
      if (filteredGroups.length === 0) {
        groupsGrid.innerHTML = '<div class="text-center" style="color:var(--text-secondary);grid-column:1/-1">Nenhum grupo encontrado.</div>';
        return;
      }
      
      filteredGroups.forEach(group => {
        const groupCard = document.createElement('div');
        groupCard.className = 'group-card';
        
        let statusBadge = '';
        if (group.status === 'active') {
          statusBadge = '<span class="badge badge-success" style="position:absolute;top:1rem;right:1rem">Ativo</span>';
        } else if (group.status === 'inactive') {
          statusBadge = '<span class="badge badge-secondary" style="position:absolute;top:1rem;right:1rem">Inativo</span>';
        } else {
          statusBadge = '<span class="badge badge-warning" style="position:absolute;top:1rem;right:1rem">Pendente</span>';
        }
        
        groupCard.innerHTML = `
          ${statusBadge}
          <h3>${escapeHtml(group.name)}</h3>
          <div class="group-details">
            <div class="group-detail"><i class="fas fa-user"></i> <span>Líder: ${escapeHtml(group.leader)}</span></div>
            <div class="group-detail"><i class="fas fa-map-marker-alt"></i> <span>${escapeHtml(group.address)}</span></div>
            <div class="group-detail"><i class="fas fa-calendar-day"></i> <span>${capitalizeFirstLetter(group.day)} às ${group.time}</span></div>
            <div class="group-detail"><i class="fas fa-users"></i> <span>Capacidade: ${group.capacity} pessoas</span></div>
            <div class="group-detail"><i class="fas fa-map"></i> <span>Zona: ${capitalizeFirstLetter(group.zone)}</span></div>
          </div>
          <div class="group-actions">
            <button class="btn btn-sm" onclick="editGroup('${group.id}')"><i class="fas fa-edit"></i> Editar</button>
            <button class="btn btn-sm btn-danger" onclick="deleteGroup('${group.id}')"><i class="fas fa-trash"></i> Excluir</button>
          </div>
        `;
        
        groupsGrid.appendChild(groupCard);
      });
    }
    
    // ====== RELATÓRIOS ======
    function loadReports() {
      const reportsList = document.getElementById('reportsList');
      reportsList.innerHTML = '<div class="text-center" style="color:var(--text-secondary)">Carregando relatórios...</div>';
      
      db.collection('reports').orderBy('date', 'desc').get()
        .then(snapshot => {
          reports = [];
          reportsList.innerHTML = '<div class="card-grid" id="reportsGrid"></div>';
          const reportsGrid = document.getElementById('reportsGrid');
          
          if (snapshot.empty) {
            reportsGrid.innerHTML = '<div class="text-center" style="color:var(--text-secondary);grid-column:1/-1">Nenhum relatório cadastrado ainda.</div>';
            return;
          }
          
          // Primeiro, carregar todos os relatórios
          const reportPromises = [];
          snapshot.forEach(doc => {
            const report = { id: doc.id, ...doc.data() };
            reports.push(report);
            
            // Buscar informações do grupo para este relatório
            const promise = db.collection('groups').doc(report.groupId).get()
              .then(groupDoc => {
                if (groupDoc.exists) {
                  report.groupName = groupDoc.data().name;
                } else {
                  report.groupName = 'Grupo não encontrado';
                }
                return report;
              })
              .catch(error => {
                console.error('Erro ao carregar grupo:', error);
                report.groupName = 'Erro ao carregar grupo';
                return report;
              });
              
            reportPromises.push(promise);
          });
          
          // Quando todas as informações de grupo estiverem carregadas, renderizar os relatórios
          Promise.all(reportPromises).then(reportsWithGroups => {
            reportsWithGroups.forEach(report => {
              const reportCard = document.createElement('div');
              reportCard.className = 'report-card';
              
              reportCard.innerHTML = `
                <h3>${escapeHtml(report.groupName)}</h3>
                <div class="report-details">
                  <div class="report-detail"><i class="fas fa-calendar"></i> <span>${formatDate(report.date)}</span></div>
                  <div class="report-detail"><i class="fas fa-users"></i> <span>Participantes: ${report.attendance}</span></div>
                  <div class="report-detail"><i class="fas fa-user-plus"></i> <span>Novos membros: ${report.newMembers}</span></div>
                  <div class="report-detail"><i class="fas fa-money-bill-wave"></i> <span>Oferta: ${report.offering} MT</span></div>
                  ${report.study ? `<div class="report-detail"><i class="fas fa-book"></i> <span>Estudo: ${escapeHtml(report.study)}</span></div>` : ''}
                </div>
                ${report.notes ? `<p><strong>Observações:</strong> ${escapeHtml(report.notes)}</p>` : ''}
                ${report.challenges ? `<p><strong>Desafios:</strong> ${escapeHtml(report.challenges)}</p>` : ''}
                <div class="report-actions">
                  <button class="btn btn-sm" onclick="editReport('${report.id}')"><i class="fas fa-edit"></i> Editar</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteReport('${report.id}')"><i class="fas fa-trash"></i> Excluir</button>
                </div>
              `;
              
              reportsGrid.appendChild(reportCard);
            });
          });
        })
        .catch(error => {
          console.error('Erro ao carregar relatórios:', error);
          reportsList.innerHTML = '<div class="text-center" style="color:var(--error-color)">Erro ao carregar relatórios.</div>';
        });
    }
    
    function saveReport() {
      const reportId = document.getElementById('reportId').value;
      const reportData = {
        groupId: document.getElementById('reportGroup').value,
        date: document.getElementById('reportDate').value,
        attendance: parseInt(document.getElementById('reportAttendance').value),
        newMembers: parseInt(document.getElementById('reportNewMembers').value),
        offering: parseFloat(document.getElementById('reportOffering').value),
        study: document.getElementById('reportStudy').value,
        notes: document.getElementById('reportNotes').value,
        challenges: document.getElementById('reportChallenges').value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      if (reportId) {
        // Atualizar relatório existente
        db.collection('reports').doc(reportId).update(reportData)
          .then(() => {
            showNotification('Relatório atualizado com sucesso!', 'success');
            closeModal('reportModal');
            loadReports();
          })
          .catch(error => {
            console.error('Erro ao atualizar relatório:', error);
            showNotification('Erro ao atualizar relatório: ' + error.message, 'error');
          });
      } else {
        // Criar novo relatório
        reportData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        
        db.collection('reports').add(reportData)
          .then(() => {
            showNotification('Relatório criado com sucesso!', 'success');
            closeModal('reportModal');
            loadReports();
          })
          .catch(error => {
            console.error('Erro ao criar relatório:', error);
            showNotification('Erro ao criar relatório: ' + error.message, 'error');
          });
      }
    }
    
    function editReport(id) {
      const report = reports.find(r => r.id === id);
      if (!report) return;
      
      document.getElementById('reportId').value = report.id;
      document.getElementById('reportGroup').value = report.groupId;
      document.getElementById('reportDate').value = report.date;
      document.getElementById('reportAttendance').value = report.attendance;
      document.getElementById('reportNewMembers').value = report.newMembers;
      document.getElementById('reportOffering').value = report.offering;
      document.getElementById('reportStudy').value = report.study || '';
      document.getElementById('reportNotes').value = report.notes || '';
      document.getElementById('reportChallenges').value = report.challenges || '';
      
      document.getElementById('reportModalTitle').textContent = 'Editar Relatório';
      openModal('reportModal');
    }
    
    function deleteReport(id) {
      if (!confirm('Tem certeza que deseja excluir este relatório?')) return;
      
      db.collection('reports').doc(id).delete()
        .then(() => {
          showNotification('Relatório excluído com sucesso!', 'success');
          loadReports();
        })
        .catch(error => {
          console.error('Erro ao excluir relatório:', error);
          showNotification('Erro ao excluir relatório: ' + error.message, 'error');
        });
    }
    
    function filterReports(query) {
      const filteredReports = reports.filter(report => {
        const group = groups.find(g => g.id === report.groupId);
        const groupName = group ? group.name : '';
        
        return (
          groupName.toLowerCase().includes(query.toLowerCase()) ||
          (report.study && report.study.toLowerCase().includes(query.toLowerCase())) ||
          (report.notes && report.notes.toLowerCase().includes(query.toLowerCase()))
        );
      });
      
      const reportsGrid = document.getElementById('reportsGrid');
      reportsGrid.innerHTML = '';
      
      if (filteredReports.length === 0) {
        reportsGrid.innerHTML = '<div class="text-center" style="color:var(--text-secondary);grid-column:1/-1">Nenhum relatório encontrado.</div>';
        return;
      }
      
      // Renderizar relatórios filtrados
      filteredReports.forEach(report => {
        const group = groups.find(g => g.id === report.groupId);
        const groupName = group ? group.name : 'Grupo não encontrado';
        
        const reportCard = document.createElement('div');
        reportCard.className = 'report-card';
        
        reportCard.innerHTML = `
          <h3>${escapeHtml(groupName)}</h3>
          <div class="report-details">
            <div class="report-detail"><i class="fas fa-calendar"></i> <span>${formatDate(report.date)}</span></div>
            <div class="report-detail"><i class="fas fa-users"></i> <span>Participantes: ${report.attendance}</span></div>
            <div class="report-detail"><i class="fas fa-user-plus"></i> <span>Novos membros: ${report.newMembers}</span></div>
            <div class="report-detail"><i class="fas fa-money-bill-wave"></i> <span>Oferta: ${report.offering} MT</span></div>
            ${report.study ? `<div class="report-detail"><i class="fas fa-book"></i> <span>Estudo: ${escapeHtml(report.study)}</span></div>` : ''}
          </div>
          ${report.notes ? `<p><strong>Observações:</strong> ${escapeHtml(report.notes)}</p>` : ''}
          ${report.challenges ? `<p><strong>Desafios:</strong> ${escapeHtml(report.challenges)}</p>` : ''}
          <div class="report-actions">
            <button class="btn btn-sm" onclick="editReport('${report.id}')"><i class="fas fa-edit"></i> Editar</button>
            <button class="btn btn-sm btn-danger" onclick="deleteReport('${report.id}')"><i class="fas fa-trash"></i> Excluir</button>
          </div>
        `;
        
        reportsGrid.appendChild(reportCard);
      });
    }
    
    function filterReportsByGroup(groupId) {
      if (!groupId) {
        loadReports();
        return;
      }
      
      const filteredReports = reports.filter(report => report.groupId === groupId);
      
      const reportsGrid = document.getElementById('reportsGrid');
      reportsGrid.innerHTML = '';
      
      if (filteredReports.length === 0) {
        reportsGrid.innerHTML = '<div class="text-center" style="color:var(--text-secondary);grid-column:1/-1">Nenhum relatório encontrado para este grupo.</div>';
        return;
      }
      
      // Renderizar relatórios filtrados
      filteredReports.forEach(report => {
        const group = groups.find(g => g.id === report.groupId);
        const groupName = group ? group.name : 'Grupo não encontrado';
        
        const reportCard = document.createElement('div');
        reportCard.className = 'report-card';
        
        reportCard.innerHTML = `
          <h3>${escapeHtml(groupName)}</h3>
          <div class="report-details">
            <div class="report-detail"><i class="fas fa-calendar"></i> <span>${formatDate(report.date)}</span></div>
            <div class="report-detail"><i class="fas fa-users"></i> <span>Participantes: ${report.attendance}</span></div>
            <div class="report-detail"><i class="fas fa-user-plus"></i> <span>Novos membros: ${report.newMembers}</span></div>
            <div class="report-detail"><i class="fas fa-money-bill-wave"></i> <span>Oferta: ${report.offering} MT</span></div>
            ${report.study ? `<div class="report-detail"><i class="fas fa-book"></i> <span>Estudo: ${escapeHtml(report.study)}</span></div>` : ''}
          </div>
          ${report.notes ? `<p><strong>Observações:</strong> ${escapeHtml(report.notes)}</p>` : ''}
          ${report.challenges ? `<p><strong>Desafios:</strong> ${escapeHtml(report.challenges)}</p>` : ''}
          <div class="report-actions">
            <button class="btn btn-sm" onclick="editReport('${report.id}')"><i class="fas fa-edit"></i> Editar</button>
            <button class="btn btn-sm btn-danger" onclick="deleteReport('${report.id}')"><i class="fas fa-trash"></i> Excluir</button>
          </div>
        `;
        
        reportsGrid.appendChild(reportCard);
      });
    }
    
    function populateGroupDropdown() {
      const groupDropdown = document.getElementById('reportGroup');
      const filterDropdown = document.getElementById('filterGroup');
      
      // Limpar dropdowns
      groupDropdown.innerHTML = '<option value="">Selecione um grupo</option>';
      filterDropdown.innerHTML = '<option value="">Todos os grupos</option>';
      
      // Adicionar grupos ativos
      const activeGroups = groups.filter(g => g.status === 'active');
      activeGroups.forEach(group => {
        groupDropdown.innerHTML += `<option value="${group.id}">${group.name}</option>`;
        filterDropdown.innerHTML += `<option value="${group.id}">${group.name}</option>`;
      });
    }
    
    // ====== FUNÇÕES UTILITÁRIAS ======
    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      
      // Limpar formulários ao fechar
      if (modalId === 'groupModal') {
        document.getElementById('groupForm').reset();
        document.getElementById('groupId').value = '';
        document.getElementById('groupModalTitle').textContent = 'Adicionar Novo Grupo';
      } else if (modalId === 'reportModal') {
        document.getElementById('reportForm').reset();
        document.getElementById('reportId').value = '';
        document.getElementById('reportModalTitle').textContent = 'Adicionar Novo Relatório';
      }
    }
    
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('pt-BR');
    }
    
    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function showNotification(message, type = 'info') {
      // Implementar um sistema de notificação simples
      alert(`${type.toUpperCase()}: ${message}`);
    }
    
    // Fechar modais ao clicar fora deles
    window.addEventListener('click', function(event) {
      const modals = document.querySelectorAll('.modal-overlay');
      modals.forEach(modal => {
        if (event.target === modal) {
          closeModal(modal.id);
        }
      });
    });
  </script>
</body>
</html>