<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel Administrativo - Ministério dos Justos Aperfeiçoados</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root {
      --primary-color:#0056b3; --primary-color-dark:#003d82; --primary-color-light:#e6f0ff;
      --secondary-color:#ff6b00; --background-primary:#ffffff; --background-secondary:#f8f9fa;
      --text-primary:#333333; --text-secondary:#666666; --text-light:#999999;
      --border-color:#e0e0e0; --shadow:0 2px 10px rgba(0,0,0,.05); --shadow-hover:0 5px 15px rgba(0,0,0,.1);
      --error-color:#d32f2f; --success-color:#388e3c; --warning-color:#f57c00; --radius:8px; --transition:.3s ease; --sidebar-width:250px;
    }
    [data-theme="dark"] {
      --primary-color:#4a90e2; --primary-color-dark:#2a5c99; --primary-color-light:#1a2a40;
      --background-primary:#121212; --background-secondary:#1E1E1E; --text-primary:#E0E0E0; --text-secondary:#b0b3b8;
      --border-color:#333; --shadow:0 4px 6px rgba(0,0,0,.3);
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Open Sans','Lato',Arial,sans-serif}
    body{background:var(--background-secondary);color:var(--text-primary);line-height:1.6}

    /* Login overlay */
    .login-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--background-secondary);z-index:3000}
    .login-card{background:var(--background-primary);border-radius:var(--radius);box-shadow:var(--shadow);padding:2rem;max-width:420px;width:92%}
    .login-card h1{font-size:1.25rem;margin-bottom:.5rem;color:var(--primary-color)}
    .login-card p{color:var(--text-secondary);margin-bottom:1.25rem}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem 1rem;border:none;border-radius:var(--radius);cursor:pointer;
         background:var(--primary-color);color:#fff;font-weight:600;transition:var(--transition);text-decoration:none}
    .btn:hover{background:var(--primary-color-dark);transform:translateY(-2px);box-shadow:var(--shadow-hover)}
    .btn-outline{background:transparent;border:1px solid var(--primary-color);color:var(--primary-color)}
    .btn-danger{background:var(--error-color)} .btn-success{background:var(--success-color)} .btn-warning{background:var(--warning-color)}
    .btn-sm{padding:.4rem .7rem;font-size:.85rem}
    .note{display:none;margin-top:.75rem;padding:.6rem;border-radius:6px;font-size:.9rem}
    .note.error{background:#ffebee;color:var(--error-color);border:1px solid #ffcdd2}
    .note.success{background:#e8f5e9;color:var(--success-color);border:1px solid #c8e6c9}

    /* Layout */
    .admin-container{display:flex;min-height:100vh}
    .admin-sidebar{width:var(--sidebar-width);background:var(--primary-color-dark);color:#fff;position:fixed;height:100vh;overflow-y:auto;z-index:1000}
    .admin-sidebar-header{padding:1.5rem 1rem;border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center;gap:.8rem}
    .admin-sidebar-header img{width:40px;height:40px;border-radius:50%;border:2px solid #fff}
    .admin-sidebar-header h2{font-size:1.1rem;font-weight:600}
    .admin-nav{padding:1rem 0}
    .nav-section{padding:.5rem 1.5rem;font-size:.8rem;text-transform:uppercase;color:rgba(255,255,255,.6);margin-top:1rem}
    .nav-item{padding:.8rem 1.5rem;display:flex;align-items:center;gap:.8rem;color:rgba(255,255,255,.85);text-decoration:none;cursor:pointer}
    .nav-item:hover,.nav-item.active{background:rgba(255,255,255,.12);color:#fff}
    .nav-item i{width:20px;text-align:center}
    .admin-main{flex:1;margin-left:var(--sidebar-width);padding:1.5rem}
    .admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border-color)}
    .admin-title{font-size:1.6rem;color:var(--primary-color)}
    .admin-card{background:var(--background-primary);border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:1.5rem;overflow:hidden}
    .card-header{padding:1rem 1.25rem;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
    .card-title{font-size:1.1rem;font-weight:600;color:var(--primary-color)}
    .card-content{padding:1.2rem;overflow-x:auto}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(220px,1fr));gap:1rem;margin-bottom:1.5rem}
    .stat-card{background:var(--background-primary);border-radius:var(--radius);padding:1rem;box-shadow:var(--shadow);display:flex;gap:.9rem;align-items:center}
    .stat-icon{width:46px;height:46px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--primary-color-light);color:var(--primary-color)}
    .stat-value{font-size:1.4rem;font-weight:700}
    .stat-label{font-size:.9rem;color:var(--text-secondary)}
    .admin-table{width:100%;border-collapse:collapse}
    .admin-table th,.admin-table td{padding:.7rem 1rem;border-bottom:1px solid var(--border-color);text-align:left}
    .admin-table th{background:var(--background-secondary)}
    .badge{display:inline-block;padding:.25rem .55rem;border-radius:20px;font-size:.75rem;font-weight:700}
    .badge-success{background:#e8f5e9;color:var(--success-color)} .badge-warning{background:#fff3e0;color:var(--warning-color)}
    .badge-info{background:#e3f2fd;color:var(--primary-color)}
    .hidden{display:none}

    /* Forms */
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;margin-bottom:1rem}
    .form-group{margin-bottom:1rem}
    .form-label{display:block;margin-bottom:.4rem;font-weight:600}
    .form-control{width:100%;padding:.7rem;border:1px solid var(--border-color);border-radius:var(--radius);background:var(--background-primary);color:var(--text-primary)}
    .form-control:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(0,86,179,.15)}
    textarea.form-control{min-height:110px;resize:vertical}

    /* Media preview */
    .media-preview{margin-top:.5rem;max-width:100%;max-height:220px;border-radius:6px;display:none}

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:2000;padding:1rem}
    .modal-content{background:var(--background-primary);border-radius:var(--radius);width:100%;max-width:680px;max-height:90vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .modal-header{padding:1rem 1.25rem;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-size:1.2rem;font-weight:700;color:var(--primary-color)}
    .modal-body{padding:1rem 1.25rem}
    .modal-footer{padding:1rem 1.25rem;border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:.6rem}

    /* Responsive sidebar */
    @media (max-width: 992px){
      .admin-sidebar{width:70px}
      .admin-sidebar-header h2,.nav-item span,.nav-section{display:none}
      .admin-main{margin-left:70px}
      .nav-item{justify-content:center;padding:.9rem}
    }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-card">
      <h1><i class="fa-solid fa-lock"></i> Acesso Administrativo</h1>
      <p>Faça login com sua conta Google autorizada para gerenciar o conteúdo.</p>
      <button class="btn" id="googleSignInBtn"><i class="fa-brands fa-google"></i> Entrar com Google</button>
      <div id="loginNote" class="note"></div>
    </div>
  </div>

  <!-- APP -->
  <div class="admin-container" id="app" style="display:none">
    <!-- Sidebar -->
    <div class="admin-sidebar">
      <div class="admin-sidebar-header">
        <img src="https://i.ibb.co/rfLWMXK7/FB-IMG-1748755074055.jpg" alt="Logo IMJA">
        <h2>Painel Administrativo</h2>
      </div>
      <nav class="admin-nav">
        <div class="nav-section">Principal</div>
        <a href="#" class="nav-item active" data-tab="dashboard"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>

        <div class="nav-section">Conteúdo</div>
        <a href="#" class="nav-item" data-tab="posts"><i class="fas fa-newspaper"></i><span>Posts</span></a>
        <a href="#" class="nav-item" data-tab="events"><i class="fas fa-calendar-alt"></i><span>Eventos</span></a>
        <a href="#" class="nav-item" data-tab="prayers"><i class="fas fa-pray"></i><span>Pedidos de Oração</span></a>

        <div class="nav-section">Sessão</div>
        <a href="#" class="nav-item" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a>
      </nav>
    </div>

    <!-- Main -->
    <div class="admin-main">
      <!-- Dashboard -->
      <div class="admin-content-section" id="dashboard">
        <div class="admin-header">
          <h1 class="admin-title">Dashboard</h1>
          <div class="admin-actions">
            <button class="btn" id="refreshBtn"><i class="fas fa-sync-alt"></i> Atualizar</button>
            <button class="btn btn-success" onclick="openModal('eventModal')"><i class="fas fa-plus"></i> Novo Evento</button>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon"><i class="fas fa-newspaper"></i></div><div><div class="stat-value" id="statPosts">0</div><div class="stat-label">Total de Posts</div></div></div>
          <div class="stat-card"><div class="stat-icon"><i class="fas fa-calendar-alt"></i></div><div><div class="stat-value" id="statEvents">0</div><div class="stat-label">Próximos Eventos</div></div></div>
          <div class="stat-card"><div class="stat-icon"><i class="fas fa-pray"></i></div><div><div class="stat-value" id="statPrayers">0</div><div class="stat-label">Pedidos de Oração</div></div></div>
        </div>

        <!-- Últimos posts -->
        <div class="admin-card">
          <div class="card-header">
            <h3 class="card-title">Últimos Posts</h3>
          </div>
          <div class="card-content">
            <table class="admin-table" id="latestPostsTable">
              <thead><tr><th>Título</th><th>Tipo</th><th>Categoria</th><th>Data</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Posts -->
      <div class="admin-content-section hidden" id="posts">
        <div class="admin-header">
          <h1 class="admin-title">Gerenciar Posts</h1>
        </div>
        <div class="admin-card">
          <div class="card-header">
            <h3 class="card-title">Novo Post</h3>
          </div>
          <div class="card-content">
            <form id="postForm">
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label" for="postTitle">Título</label>
                  <input id="postTitle" class="form-control" type="text" required>
                </div>
                <div class="form-group">
                  <label class="form-label" for="postType">Tipo</label>
                  <select id="postType" class="form-control" onchange="togglePostFields()">
                    <option value="text">Texto</option>
                    <option value="image">Imagem</option>
                    <option value="video">Vídeo</option>
                    <option value="audio">Áudio</option>
                    <option value="youtube">YouTube</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label" for="postCategory">Categoria</label>
                  <select id="postCategory" class="form-control">
                    <option value="general">Geral</option>
                    <option value="news">Notícias</option>
                    <option value="devotional">Devocional</option>
                    <option value="event">Evento</option>
                    <option value="announcement">Anúncio</option>
                  </select>
                </div>
              </div>

              <div class="form-group" id="postContentField">
                <label class="form-label" for="postContent">Conteúdo</label>
                <textarea id="postContent" class="form-control" placeholder="Digite o conteúdo..."></textarea>
              </div>

              <div class="form-group hidden" id="imageField">
                <label class="form-label" for="postImage">Imagem</label>
                <input id="postImage" class="form-control" type="file" accept="image/*">
                <img id="imagePreview" class="media-preview" alt="Preview"/>
              </div>

              <div class="form-group hidden" id="videoField">
                <label class="form-label" for="postVideo">Vídeo</label>
                <input id="postVideo" class="form-control" type="file" accept="video/*">
              </div>

              <div class="form-group hidden" id="audioField">
                <label class="form-label" for="postAudio">Áudio</label>
                <input id="postAudio" class="form-control" type="file" accept="audio/*">
              </div>

              <div class="form-group hidden" id="youtubeField">
                <label class="form-label" for="youtubeUrl">URL do YouTube</label>
                <input id="youtubeUrl" class="form-control" type="url" placeholder="https://www.youtube.com/watch?v=...">
              </div>

              <div class="form-group" style="display:flex;gap:.6rem">
                <button type="button" class="btn btn-success" id="createPostBtn" onclick="createOrUpdatePost()">
                  <i class="fas fa-paper-plane"></i> Publicar Post
                </button>
                <button type="button" class="btn btn-outline hidden" id="cancelEditBtn" onclick="clearPostForm()">
                  Cancelar Edição
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="admin-card">
          <div class="card-header">
            <h3 class="card-title">Posts Publicados</h3>
            <div class="card-actions" style="display:flex;gap:.5rem;align-items:center">
              <input id="searchPosts" class="form-control" placeholder="Buscar posts..." oninput="filterPosts(this.value)" style="max-width:240px">
            </div>
          </div>
          <div class="card-content">
            <div id="postsList">
              <div class="text-center" style="color:var(--text-secondary)">Carregando posts...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Eventos -->
      <div class="admin-content-section hidden" id="events">
        <div class="admin-header">
          <h1 class="admin-title">Gerenciar Eventos</h1>
          <button class="btn btn-success" onclick="openModal('eventModal')"><i class="fas fa-plus"></i> Novo Evento</button>
        </div>
        <div class="admin-card">
          <div class="card-header">
            <h3 class="card-title">Todos os Eventos</h3>
          </div>
          <div class="card-content">
            <table class="admin-table" id="eventsTable">
              <thead><tr><th>Título</th><th>Data</th><th>Local</th><th>Status</th><th>Ações</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Pedidos de Oração -->
      <div class="admin-content-section hidden" id="prayers">
        <div class="admin-header">
          <h1 class="admin-title">Pedidos de Oração</h1>
        </div>
        <div class="admin-card">
          <div class="card-header">
            <h3 class="card-title">Todos os Pedidos</h3>
          </div>
          <div class="card-content">
            <table class="admin-table" id="prayersTable">
              <thead><tr><th>Nome</th><th>Data</th><th>Pedido</th><th>Status</th><th>Ações</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Modal Evento -->
  <div class="modal-overlay" id="eventModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="eventModalTitle">Adicionar Novo Evento</h2>
        <button class="btn btn-outline btn-sm" onclick="closeModal('eventModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="eventForm">
          <input type="hidden" id="eventId">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="eventTitle">Título do Evento</label>
              <input type="text" id="eventTitle" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="eventDate">Data do Evento</label>
              <input type="datetime-local" id="eventDate" class="form-control" required>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="eventLocation">Local</label>
              <input type="text" id="eventLocation" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="eventCategory">Categoria</label>
              <select id="eventCategory" class="form-control" required>
                <option value="">Selecione</option>
                <option value="culto">Culto</option>
                <option value="estudo">Estudo Bíblico</option>
                <option value="retiro">Retiro</option>
                <option value="conferencia">Conferência</option>
                <option value="outro">Outro</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="eventDescription">Descrição</label>
            <textarea id="eventDescription" class="form-control" rows="4" required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label" for="eventImage">Imagem (URL)</label>
            <input type="url" id="eventImage" class="form-control">
          </div>
          <div class="form-group">
            <label class="form-label" for="eventMaxAttendees">Máximo de Participantes (opcional)</label>
            <input type="number" id="eventMaxAttendees" class="form-control" min="0">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('eventModal')">Cancelar</button>
        <button class="btn btn-success" type="submit" form="eventForm">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <script>
    // ====== CONFIG FIREBASE ======
    const firebaseConfig = {
      apiKey: "AIzaSyBgWfocz6rpycz3SiJJ39Nfc1gNUd6kafk",
      authDomain: "imjachurch.firebaseapp.com",
      projectId: "imjachurch",
      storageBucket: "imjachurch.appspot.com",
      messagingSenderId: "145864254479",
      appId: "1:145864254479:web:3c1e6f5b3b5e5f5b5e5f5b"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ====== ALLOWLIST DE ADMINS (Google) ======
    const ALLOWED_EMAILS = new Set([
      "denzelkhossa@gmail.com",
      "ministerio.554411@gmail.com",
      "calvinocossa6@gmail.com",
      "hjsdesousa@gmail.com"
      // adicione mais aqui se quiser
    ]);

    // ====== UI HELPERS ======
    function showLoginNote(msg, type='error'){
      const n = document.getElementById('loginNote');
      n.textContent = msg;
      n.className = 'note ' + (type==='success' ? 'success':'error');
      n.style.display = 'block';
      setTimeout(()=>{ n.style.display = 'none'; }, 5000);
    }
    function gate(open){
      document.getElementById('loginOverlay').style.display = open ? 'none' : 'flex';
      document.getElementById('app').style.display = open ? 'block' : 'none';
    }
    function openModal(id){ document.getElementById(id).style.display='flex'; }
    function closeModal(id){ document.getElementById(id).style.display='none'; }
    function formatDate(ts){
      try{
        if(!ts) return '-';
        if (ts.toDate) return ts.toDate().toLocaleString('pt-BR');
        return new Date(ts).toLocaleString('pt-BR');
      }catch(e){ return '-'; }
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
    function nl2br(s){ return (s||'').replace(/\n/g, '<br/>'); }
    function extractYouTubeId(url){
      const re=/^.*(?:youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
      const m = (url||'').match(re);
      return (m && m[1] && m[1].length===11) ? m[1] : null;
    }

    // ====== NAV TABS ======
    document.querySelectorAll('.nav-item[data-tab]').forEach(a=>{
      a.addEventListener('click', e=>{
        e.preventDefault();
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
        a.classList.add('active');
        const tab = a.getAttribute('data-tab');
        document.querySelectorAll('.admin-content-section').forEach(s=>s.classList.add('hidden'));
        document.getElementById(tab).classList.remove('hidden');
      });
    });

    // ====== AUTH (GOOGLE) ======
    document.getElementById('googleSignInBtn').addEventListener('click', async ()=>{
      try{
        const provider = new firebase.auth.GoogleAuthProvider();
        const result = await auth.signInWithPopup(provider);
        const email = result.user.email?.toLowerCase();
        if(!ALLOWED_EMAILS.has(email)){
          await auth.signOut();
          showLoginNote('Acesso negado: e-mail não autorizado.');
          return;
        }
        // Login bem-sucedido
        gate(true);
        await Promise.all([loadPosts(), loadEvents(), loadPrayers(), refreshStats()]);
      }catch(err){
        console.error(err);
        showLoginNote('Falha ao autenticar: ' + err.message);
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async (e)=>{
      e.preventDefault();
      await auth.signOut();
    });

    // Verificar se já está logado ao carregar a página
    auth.onAuthStateChanged(async (user)=>{
      if(user){
        const email = (user.email||'').toLowerCase();
        if(ALLOWED_EMAILS.has(email)){
          gate(true);
          await Promise.all([loadPosts(), loadEvents(), loadPrayers(), refreshStats()]);
        } else {
          await auth.signOut();
          gate(false);
        }
      } else {
        gate(false);
      }
    });

    // ====== DASHBOARD ======
    async function refreshStats(){
      try{
        const [p,e,pr] = await Promise.all([
          db.collection('posts').get(),
          db.collection('events').get(),
          db.collection('prayers').get()
        ]);
        document.getElementById('statPosts').textContent  = p.size;
        document.getElementById('statEvents').textContent = e.size;
        document.getElementById('statPrayers').textContent= pr.size;

        // últimos posts
        const latest = await db.collection('posts').orderBy('createdAt','desc').limit(5).get();
        const tbody = document.querySelector('#latestPostsTable tbody');
        tbody.innerHTML = '';
        latest.forEach(doc=>{
          const d = doc.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(d.title||'-')}</td>
                          <td>${escapeHtml(d.type||'-')}</td>
                          <td>${escapeHtml(d.category||'-')}</td>
                          <td>${formatDate(d.createdAt)}</td>`;
          tbody.appendChild(tr);
        });
      }catch(e){ console.error(e); }
    }
    document.getElementById('refreshBtn').addEventListener('click', refreshStats);

    // ====== POSTS (CRUD) ======
    let postsCache = [];
    let currentEditPostId = null;

    function togglePostFields(){
      const t = document.getElementById('postType').value;
      const show = id => document.getElementById(id).classList.remove('hidden');
      const hide = id => document.getElementById(id).classList.add('hidden');
      hide('imageField'); hide('videoField'); hide('audioField'); hide('youtubeField');
      show('postContentField');
      if(t==='image') show('imageField');
      if(t==='video') show('videoField');
      if(t==='audio') show('audioField');
      if(t==='youtube') show('youtubeField');
    }
    document.getElementById('postImage').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ev => { const img = document.getElementById('imagePreview'); img.src = ev.target.result; img.style.display='block'; };
      r.readAsDataURL(f);
    });

    async function uploadFile(file, folder){
      const ref = storage.ref().child(`${folder}/${Date.now()}_${file.name}`);
      await ref.put(file);
      return await ref.getDownloadURL();
    }

    async function createOrUpdatePost(){
      const title = document.getElementById('postTitle').value.trim();
      const type  = document.getElementById('postType').value;
      const content = document.getElementById('postContent').value.trim();
      const category = document.getElementById('postCategory').value;

      if(!title || !content){ alert('Preencha título e conteúdo.'); return; }

      const btn = document.getElementById('createPostBtn');
      const old = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...'; btn.disabled = true;
      try{
        let mediaUrl = '';
        if(type==='image'){
          const f = document.getElementById('postImage').files[0];
          if(f) mediaUrl = await uploadFile(f,'images');
        }else if(type==='video'){
          const f = document.getElementById('postVideo').files[0];
          if(f) mediaUrl = await uploadFile(f,'videos');
        }else if(type==='audio'){
          const f = document.getElementById('postAudio').files[0];
          if(f) mediaUrl = await uploadFile(f,'audios');
        }else if(type==='youtube'){
          mediaUrl = document.getElementById('youtubeUrl').value.trim();
        }

        const user = auth.currentUser;
        const base = {
          title, content, type, category, mediaUrl,
          author: user?.displayName || 'Administrador',
          authorId: user?.uid || 'admin',
        };

        if(currentEditPostId){
          await db.collection('posts').doc(currentEditPostId).update({
            ...base,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          alert('Post atualizado com sucesso!');
        }else{
          await db.collection('posts').add({
            ...base,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          alert('Post publicado com sucesso!');
        }
        clearPostForm();
        await loadPosts();
        await refreshStats();
      }catch(err){
        console.error(err); alert('Erro ao salvar post: ' + err.message);
      }finally{
        btn.innerHTML = old; btn.disabled = false;
      }
    }

    function clearPostForm(){
      document.getElementById('postForm').reset();
      document.getElementById('imagePreview').style.display = 'none';
      currentEditPostId = null;
      document.getElementById('createPostBtn').innerHTML = '<i class="fas fa-paper-plane"></i> Publicar Post';
      document.getElementById('cancelEditBtn').classList.add('hidden');
      togglePostFields();
    }

    function renderPostItem(p){
      let media = '';
      if(p.type==='image' && p.mediaUrl){
        media = `<div style="margin-top:.5rem"><img src="${p.mediaUrl}" style="max-width:100%;border-radius:6px"/></div>`;
      }else if(p.type==='video' && p.mediaUrl){
        media = `<div style="margin-top:.5rem"><video src="${p.mediaUrl}" controls style="max-width:100%;border-radius:6px"></video></div>`;
      }else if(p.type==='audio' && p.mediaUrl){
        media = `<div style="margin-top:.5rem"><audio src="${p.mediaUrl}" controls></audio></div>`;
      }else if(p.type==='youtube' && p.mediaUrl){
        const id = extractYouTubeId(p.mediaUrl);
        if(id){
          media = `<div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;margin-top:.7rem;border-radius:8px">
                    <iframe src="https://www.youtube.com/embed/${id}" style="position:absolute;top:0;left:0;width:100%;height:100%;border:0" allowfullscreen></iframe>
                  </div>`;
        }
      }
      const div = document.createElement('div');
      div.className = 'admin-card';
      div.innerHTML = `
        <div class="card-content">
          <div style="display:flex;justify-content:space-between;gap:.75rem;align-items:center">
            <div>
              <div style="font-weight:700">${escapeHtml(p.title||'')}</div>
              <div style="color:var(--text-secondary);font-size:.85rem">por ${escapeHtml(p.author||'')} • ${p.date}</div>
            </div>
            <div>
              <span class="badge badge-info">${escapeHtml(p.category||'')}</span>
              <span class="badge badge-success">${escapeHtml(p.type||'')}</span>
            </div>
          </div>
          <div style="margin-top:.5rem">${nl2br(escapeHtml(p.content||''))}</div>
          ${media}
          <div style="display:flex;gap:.5rem;margin-top:.75rem">
            <button class="btn btn-warning btn-sm" onclick="editPost('${p.id}')"><i class="fas fa-edit"></i> Editar</button>
            <button class="btn btn-danger btn-sm" onclick="deletePost('${p.id}')"><i class="fas fa-trash"></i> Excluir</button>
          </div>
        </div>`;
      return div;
    }

    async function loadPosts(){
      const container = document.getElementById('postsList');
      container.innerHTML = '<div class="text-center" style="color:var(--text-secondary)">Carregando posts...</div>';
      const snap = await db.collection('posts').orderBy('createdAt','desc').get();
      postsCache = [];
      container.innerHTML = '';
      if(snap.empty){
        container.innerHTML = '<div class="text-center" style="color:var(--text-secondary)">Nenhum post publicado ainda.</div>';
        return;
      }
      snap.forEach(doc=>{
        const d = doc.data();
        const p = {
          id: doc.id, ...d,
          date: d.createdAt ? d.createdAt.toDate().toLocaleDateString('pt-BR') : '-'
        };
        postsCache.push(p);
        container.appendChild(renderPostItem(p));
      });
    }

    function filterPosts(term){
      term = (term||'').toLowerCase();
      const container = document.getElementById('postsList');
      container.innerHTML = '';
      const list = term
        ? postsCache.filter(p => (p.title||'').toLowerCase().includes(term) || (p.content||'').toLowerCase().includes(term))
        : postsCache;
      if(list.length===0){
        container.innerHTML = '<div class="text-center" style="color:var(--text-secondary)">Nenhum post encontrado.</div>';
        return;
      }
      list.forEach(p => container.appendChild(renderPostItem(p)));
    }

    function editPost(id){
      const p = postsCache.find(x=>x.id===id);
      if(!p) return;
      document.getElementById('postTitle').value = p.title||'';
      document.getElementById('postType').value  = p.type||'text';
      document.getElementById('postCategory').value = p.category||'general';
      document.getElementById('postContent').value = p.content||'';
      if(p.type==='youtube') document.getElementById('youtubeUrl').value = p.mediaUrl||'';
      if(p.type==='image' && p.mediaUrl){
        const img = document.getElementById('imagePreview'); img.src = p.mediaUrl; img.style.display='block';
      }
      togglePostFields();
      currentEditPostId = id;
      document.getElementById('createPostBtn').innerHTML = '<i class="fas fa-save"></i> Atualizar Post';
      document.getElementById('cancelEditBtn').classList.remove('hidden');
      // vai para a aba posts
      document.querySelector(".nav-item[data-tab='posts']").click();
      document.getElementById('postTitle').focus();
    }

    async function deletePost(id){
      if(!confirm('Tem certeza que deseja excluir este post?')) return;
      await db.collection('posts').doc(id).delete();
      await loadPosts(); await refreshStats();
      alert('Post excluído com sucesso!');
    }

    // ====== EVENTOS (CRUD) ======
    let editingEventId = null;

    async function loadEvents(){
      const tbody = document.querySelector('#eventsTable tbody');
      tbody.innerHTML = '<tr><td colspan="5">Carregando...</td></tr>';
      const snap = await db.collection('events').orderBy('date','asc').get();
      tbody.innerHTML = '';
      if(snap.empty){
        tbody.innerHTML = '<tr><td colspan="5">Nenhum evento cadastrado.</td></tr>';
        return;
      }
      snap.forEach(doc=>{
        const d = doc.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(d.title||'-')}</td>
          <td>${d.date ? formatDate(d.date) : '-'}</td>
          <td>${escapeHtml(d.location||'-')}</td>
          <td><span class="badge badge-success">${(d.active===false)?'Inativo':'Ativo'}</span></td>
          <td>
            <button class="btn btn-sm btn-outline" onclick='openEditEvent(${JSON.stringify({id:doc.id,...d}).replace(/"/g,"&quot;")})'><i class="fas fa-edit"></i></button>
            <button class="btn btn-sm btn-danger" onclick="deleteEvent('${doc.id}')"><i class="fas fa-trash"></i></button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function openEditEvent(ev){
      editingEventId = ev.id;
      document.getElementById('eventModalTitle').textContent = 'Editar Evento';
      document.getElementById('eventId').value = ev.id;
      document.getElementById('eventTitle').value = ev.title||'';
      document.getElementById('eventLocation').value = ev.location||'';
      document.getElementById('eventCategory').value = ev.category||'';
      document.getElementById('eventDescription').value = ev.description||'';
      document.getElementById('eventImage').value = ev.imageUrl||'';
      document.getElementById('eventMaxAttendees').value = ev.maxAttendees||'';
      // data
      try{
        const date = ev.date?.toDate ? ev.date.toDate() : (ev.date? new Date(ev.date): null);
        if(date){
          const iso = new Date(date.getTime() - (date.getTimezoneOffset()*60000)).toISOString().slice(0,16);
          document.getElementById('eventDate').value = iso;
        }
      }catch(e){}
      openModal('eventModal');
    }

    document.getElementById('eventForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = {
        title: document.getElementById('eventTitle').value.trim(),
        location: document.getElementById('eventLocation').value.trim(),
        category: document.getElementById('eventCategory').value,
        description: document.getElementById('eventDescription').value.trim(),
        imageUrl: document.getElementById('eventImage').value.trim() || '',
        maxAttendees: Number(document.getElementById('eventMaxAttendees').value)||null,
        active: true
      };
      const dateStr = document.getElementById('eventDate').value;
      if(dateStr) payload.date = firebase.firestore.Timestamp.fromDate(new Date(dateStr));

      try{
        if(editingEventId){
          await db.collection('events').doc(editingEventId).update({
            ...payload, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          alert('Evento atualizado!');
        }else{
          await db.collection('events').add({
            ...payload,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          alert('Evento criado!');
        }
        closeModal('eventModal'); editingEventId = null;
        (e.target).reset();
        await loadEvents(); await refreshStats();
      }catch(err){ console.error(err); alert('Erro ao salvar evento: ' + err.message); }
    });

    async function deleteEvent(id){
      if(!confirm('Excluir este evento?')) return;
      await db.collection('events').doc(id).delete();
      await loadEvents(); await refreshStats();
      alert('Evento excluído.');
    }

    // ====== PRAYERS (LISTAR + EXCLUIR) ======
    async function loadPrayers(){
      const tbody = document.querySelector('#prayersTable tbody');
      tbody.innerHTML = '<tr><td colspan="5">Carregando...</td></tr>';
      const snap = await db.collection('prayers').orderBy('createdAt','desc').get();
      tbody.innerHTML = '';
      if(snap.empty){
        tbody.innerHTML = '<tr><td colspan="5">Nenhum pedido encontrado.</td></tr>';
        return;
      }
      snap.forEach(doc=>{
        const d = doc.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(d.name||'-')}</td>
          <td>${formatDate(d.createdAt)}</td>
          <td>${escapeHtml(d.request||'-')}</td>
          <td><span class="badge ${d.status==='Pendente'?'badge-warning':'badge-success'}">${escapeHtml(d.status||'Pendente')}</span></td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="deletePrayer('${doc.id}')"><i class="fas fa-trash"></i></button>
          </td>`;
        tbody.appendChild(tr);
      });
    }
    async function deletePrayer(id){
      if(!confirm('Excluir este pedido de oração?')) return;
      await db.collection('prayers').doc(id).delete();
      await loadPrayers(); await refreshStats();
      alert('Pedido excluído.');
    }

    // ====== INIT ======
    document.addEventListener('DOMContentLoaded', ()=>{
      // fecha modal clicando fora
      document.querySelectorAll('.modal-overlay').forEach(ov=>{
        ov.addEventListener('click', (e)=>{ if(e.target===ov) closeModal(ov.id); });
      });
      // campos dinâmicos de post
      togglePostFields();
    });
  </script>
</body>
</html>